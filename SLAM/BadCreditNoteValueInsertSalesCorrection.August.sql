
DECLARE @res TABLE(customer VARCHAR(3), TransactionDate Date, DailyDiscountValue FLOAT, DailyCardValue FLOAT, DailyCashValue FLOAT, DailyPettyCashValue FLOAT, ProductCode VARCHAR(20), Qty INT, Value FLOAT, LineDisount FLOAT)

INSERT INTO  @res
SELECT	DISTINCT	LTRIM(RTRIM(h.customer)), 
				'2019-08-31' AS TransactionDate,
				0 AS DailyDiscountValue,
				0 AS DailyCardValue,
				0 AS DailyCashValue,
				0 AS DailyPettyCashValue,
				LTRIM(RTRIM(d.product)) AS ProductCode,  
				SUM(CASE d.line_type WHEN 'S' THEN '1' ELSE d.order_qty END) AS Qty, /* SERVICE CODES HAVE 0 PRICE SO USE net_price instea */
				MAX(d.list_price) AS Value,
				0 AS LineDisount

	FROM		demo.scheme.opheadm h
	INNER JOIN 	demo.scheme.opdetm d
	ON			h.order_no = d.order_no
	WHERE		h.invoice_no IN ('OP/C015843','OP/C015844','OP/C015845','OP/C015974','OP/C015975','OP/C015976','OP/C016105','OP/C016106','OP/C016107','OP/C016236','OP/C016237','OP/C016238','OP/C016367','OP/C016368','OP/C016369','OP/C016505','OP/C016513','OP/C015840','OP/C015841','OP/C015842','OP/C015846','OP/C015847','OP/C015848','OP/C015849','OP/C015977','OP/C015978','OP/C015979','OP/C015980','OP/C016108','OP/C016109','OP/C016110','OP/C016111','OP/C016239','OP/C016240','OP/C016241','OP/C016242','OP/C016370','OP/C016371','OP/C016372','OP/C016373','OP/C016500','OP/C016506','OP/C015850','OP/C015851','OP/C015852','OP/C015853','OP/C015854','OP/C015855','OP/C015981','OP/C015982','OP/C015983','OP/C015984','OP/C015985','OP/C015986','OP/C016112','OP/C016113','OP/C016114','OP/C016115','OP/C016116','OP/C016117','OP/C016243','OP/C016244','OP/C016245','OP/C016246','OP/C016247','OP/C016248','OP/C016374','OP/C016375','OP/C016376','OP/C016377','OP/C016378','OP/C016379','OP/C016501','OP/C016509','OP/C015856','OP/C015987','OP/C016118','OP/C016249','OP/C016380','OP/C015857','OP/C015860','OP/C015861','OP/C015862','OP/C015988','OP/C015991','OP/C015992','OP/C015993','OP/C016119','OP/C016122','OP/C016123','OP/C016124','OP/C016250','OP/C016253','OP/C016254','OP/C016255','OP/C016381','OP/C016384','OP/C016385','OP/C016386','OP/C015858','OP/C015859','OP/C015989','OP/C015990','OP/C016120','OP/C016121','OP/C016251','OP/C016252','OP/C016382','OP/C016383','OP/C015865','OP/C015996','OP/C016127','OP/C016258','OP/C016389','OP/C015863','OP/C015864','OP/C015994','OP/C015995','OP/C016125','OP/C016126','OP/C016256','OP/C016257','OP/C016387','OP/C016388','OP/I050551','OP/C015866','OP/C015868','OP/C015997','OP/C015999','OP/C016128','OP/C016130','OP/C016259','OP/C016261','OP/C016390','OP/C016392','OP/C015867','OP/C015869','OP/C015998','OP/C016000','OP/C016129','OP/C016131','OP/C016260','OP/C016262','OP/C016391','OP/C016393','OP/C015870','OP/C016001','OP/C016132','OP/C016263','OP/C016394','OP/I050554','OP/C015871','OP/C016002','OP/C016133','OP/C016264','OP/C016395','OP/C016498','OP/I050556','OP/C015874','OP/C015875','OP/C015876','OP/C015877','OP/C015878','OP/C016005','OP/C016006','OP/C016007','OP/C016008','OP/C016009','OP/C016136','OP/C016137','OP/C016138','OP/C016139','OP/C016140','OP/C016267','OP/C016268','OP/C016269','OP/C016270','OP/C016271','OP/C016398','OP/C016399','OP/C016400','OP/C016401','OP/C016402','OP/C015873','OP/C016004','OP/C016135','OP/C016266','OP/C016397','OP/C015881','OP/C016012','OP/C016143','OP/C016274','OP/C016405','OP/C015879','OP/C015880','OP/C016010','OP/C016011','OP/C016141','OP/C016142','OP/C016272','OP/C016273','OP/C016403','OP/C016404','OP/C015882','OP/C016013','OP/C016144','OP/C016275','OP/C016406','OP/C015883','OP/C016014','OP/C016145','OP/C016276','OP/C016407','OP/C015884','OP/C015885','OP/C015886','OP/C016015','OP/C016016','OP/C016017','OP/C016146','OP/C016147','OP/C016148','OP/C016277','OP/C016278','OP/C016279','OP/C016408','OP/C016409','OP/C016410','OP/C015887','OP/C016018','OP/C016149','OP/C016280','OP/C016411','OP/C015888','OP/C016019','OP/C016150','OP/C016281','OP/C016412','OP/C015890','OP/C015891','OP/C016021','OP/C016022','OP/C016152','OP/C016153','OP/C016283','OP/C016284','OP/C016414','OP/C016415','OP/C015892','OP/C016023','OP/C016154','OP/C016285','OP/C016416','OP/C015893','OP/C016024','OP/C016155','OP/C016286','OP/C016417','OP/C015894','OP/C015895','OP/C016025','OP/C016026','OP/C016156','OP/C016157','OP/C016287','OP/C016288','OP/C016418','OP/C016419','OP/C015896','OP/C016027','OP/C016158','OP/C016289','OP/C016420','OP/C015897','OP/C015898','OP/C015899','OP/C015900','OP/C015901','OP/C015902','OP/C016028','OP/C016029','OP/C016030','OP/C016031','OP/C016032','OP/C016033','OP/C016159','OP/C016160','OP/C016161','OP/C016162','OP/C016163','OP/C016164','OP/C016290','OP/C016291','OP/C016292','OP/C016293','OP/C016294','OP/C016295','OP/C016421','OP/C016422','OP/C016423','OP/C016424','OP/C016425','OP/C016426','OP/I050566','OP/C015904','OP/C015905','OP/C015906','OP/C015907','OP/C016035','OP/C016036','OP/C016037','OP/C016038','OP/C016166','OP/C016167','OP/C016168','OP/C016169','OP/C016297','OP/C016298','OP/C016299','OP/C016300','OP/C016428','OP/C016429','OP/C016430','OP/C016431','OP/C016502','OP/C015908','OP/C015909','OP/C016039','OP/C016040','OP/C016170','OP/C016171','OP/C016301','OP/C016302','OP/C016432','OP/C016433','OP/I050529','OP/C015910','OP/C015912','OP/C015913','OP/C016041','OP/C016043','OP/C016044','OP/C016172','OP/C016174','OP/C016175','OP/C016303','OP/C016305','OP/C016306','OP/C016434','OP/C016436','OP/C016437','OP/C015911','OP/C016042','OP/C016173','OP/C016304','OP/C016435','OP/C015914','OP/C016045','OP/C016176','OP/C016307','OP/C016438','OP/C015915','OP/C015916','OP/C015917','OP/C015918','OP/C016046','OP/C016047','OP/C016048','OP/C016049','OP/C016177','OP/C016178','OP/C016179','OP/C016180','OP/C016308','OP/C016309','OP/C016310','OP/C016311','OP/C016439','OP/C016440','OP/C016441','OP/C016442','OP/C016510','OP/C015919','OP/C015921','OP/C015922','OP/C015923','OP/C016050','OP/C016052','OP/C016053','OP/C016054','OP/C016181','OP/C016183','OP/C016184','OP/C016185','OP/C016312','OP/C016314','OP/C016315','OP/C016316','OP/C016443','OP/C016445','OP/C016446','OP/C016447','OP/C016503','OP/C016511','OP/C016514','OP/C015920','OP/C016051','OP/C016182','OP/C016313','OP/C016444','OP/C015924','OP/C015925','OP/C016055','OP/C016056','OP/C016186','OP/C016187','OP/C016317','OP/C016318','OP/C016448','OP/C016449','OP/C016512','OP/C015926','OP/C016057','OP/C016188','OP/C016319','OP/C016450','OP/C015928','OP/C015929','OP/C015930','OP/C015932','OP/C016059','OP/C016060','OP/C016061','OP/C016063','OP/C016190','OP/C016191','OP/C016192','OP/C016194','OP/C016321','OP/C016322','OP/C016323','OP/C016325','OP/C016452','OP/C016453','OP/C016454','OP/C016456','OP/C016499','OP/C016515','OP/C015931','OP/C016062','OP/C016193','OP/C016324','OP/C016455','OP/C015933','OP/C015935','OP/C015936','OP/C016064','OP/C016066','OP/C016067','OP/C016195','OP/C016197','OP/C016198','OP/C016326','OP/C016328','OP/C016329','OP/C016457','OP/C016459','OP/C016460','OP/C015934','OP/C016065','OP/C016196','OP/C016327','OP/C016458','OP/C015937','OP/C015938','OP/C015939','OP/C015940','OP/C015941','OP/C015942','OP/C016068','OP/C016069','OP/C016070','OP/C016071','OP/C016072','OP/C016073','OP/C016199','OP/C016200','OP/C016201','OP/C016202','OP/C016203','OP/C016204','OP/C016330','OP/C016331','OP/C016332','OP/C016333','OP/C016334','OP/C016335','OP/C016461','OP/C016462','OP/C016463','OP/C016464','OP/C016465','OP/C016466','OP/C015943','OP/C016074','OP/C016205','OP/C016336','OP/C016467','OP/C015947','OP/C015948','OP/C015949','OP/C015950','OP/C016078','OP/C016079','OP/C016080','OP/C016081','OP/C016209','OP/C016210','OP/C016211','OP/C016212','OP/C016340','OP/C016341','OP/C016342','OP/C016343','OP/C016471','OP/C016472','OP/C016473','OP/C016474','OP/C015945','OP/C015946','OP/C016076','OP/C016077','OP/C016207','OP/C016208','OP/C016338','OP/C016339','OP/C016469','OP/C016470','OP/C015951','OP/C015952','OP/C016082','OP/C016083','OP/C016213','OP/C016214','OP/C016344','OP/C016345','OP/C016475','OP/C016476','OP/C015953','OP/C015955','OP/C015956','OP/C015957','OP/C015958','OP/C016084','OP/C016086','OP/C016087','OP/C016088','OP/C016089','OP/C016215','OP/C016217','OP/C016218','OP/C016219','OP/C016220','OP/C016346','OP/C016348','OP/C016349','OP/C016350','OP/C016351','OP/C016477','OP/C016479','OP/C016480','OP/C016481','OP/C016482','OP/C016504','OP/C016507','OP/C016516','OP/C016517','OP/C015954','OP/C015959','OP/C016085','OP/C016090','OP/C016216','OP/C016221','OP/C016347','OP/C016352','OP/C016478','OP/C016483','OP/C016508','OP/C015961','OP/C015962','OP/C016092','OP/C016093','OP/C016223','OP/C016224','OP/C016354','OP/C016355','OP/C016485','OP/C016486','OP/C015963','OP/C016094','OP/C016225','OP/C016356','OP/C016487','OP/C015964','OP/C015965','OP/C015966','OP/C015967','OP/C016095','OP/C016096','OP/C016097','OP/C016098','OP/C016226','OP/C016227','OP/C016228','OP/C016229','OP/C016357','OP/C016358','OP/C016359','OP/C016360','OP/C016488','OP/C016489','OP/C016490','OP/C016491','OP/C015969','OP/C015970','OP/C015971','OP/C015972','OP/C016100','OP/C016101','OP/C016102','OP/C016103','OP/C016231','OP/C016232','OP/C016233','OP/C016234','OP/C016362','OP/C016363','OP/C016364','OP/C016365','OP/C016493','OP/C016494','OP/C016495','OP/C016496','OP/C015973','OP/C016104','OP/C016235','OP/C016366','OP/C016497')
	AND			d.despatched_qty > 0
	AND			h.order_no	LIKE '%CN%'
	AND			d.line_type <> 'S'
	GROUP BY 	LTRIM(RTRIM(h.customer)), LTRIM(RTRIM(d.product)),d.line_type
	ORDER BY	1, 2


	UPDATE 	r
	SET		r.DailyDiscountValue = t.discount
	FROM	@res r, 
	(SELECT		SUM(d1.val) AS discount, h1.customer
				 FROM			demo.scheme.opheadm h1
			INNER JOIN 	demo.scheme.opdetm d1
			ON			h1.order_no = d1.order_no
			WHERE		h1.invoice_no IN ('OP/C015843','OP/C015844','OP/C015845','OP/C015974','OP/C015975','OP/C015976','OP/C016105','OP/C016106','OP/C016107','OP/C016236','OP/C016237','OP/C016238','OP/C016367','OP/C016368','OP/C016369','OP/C016505','OP/C016513','OP/C015840','OP/C015841','OP/C015842','OP/C015846','OP/C015847','OP/C015848','OP/C015849','OP/C015977','OP/C015978','OP/C015979','OP/C015980','OP/C016108','OP/C016109','OP/C016110','OP/C016111','OP/C016239','OP/C016240','OP/C016241','OP/C016242','OP/C016370','OP/C016371','OP/C016372','OP/C016373','OP/C016500','OP/C016506','OP/C015850','OP/C015851','OP/C015852','OP/C015853','OP/C015854','OP/C015855','OP/C015981','OP/C015982','OP/C015983','OP/C015984','OP/C015985','OP/C015986','OP/C016112','OP/C016113','OP/C016114','OP/C016115','OP/C016116','OP/C016117','OP/C016243','OP/C016244','OP/C016245','OP/C016246','OP/C016247','OP/C016248','OP/C016374','OP/C016375','OP/C016376','OP/C016377','OP/C016378','OP/C016379','OP/C016501','OP/C016509','OP/C015856','OP/C015987','OP/C016118','OP/C016249','OP/C016380','OP/C015857','OP/C015860','OP/C015861','OP/C015862','OP/C015988','OP/C015991','OP/C015992','OP/C015993','OP/C016119','OP/C016122','OP/C016123','OP/C016124','OP/C016250','OP/C016253','OP/C016254','OP/C016255','OP/C016381','OP/C016384','OP/C016385','OP/C016386','OP/C015858','OP/C015859','OP/C015989','OP/C015990','OP/C016120','OP/C016121','OP/C016251','OP/C016252','OP/C016382','OP/C016383','OP/C015865','OP/C015996','OP/C016127','OP/C016258','OP/C016389','OP/C015863','OP/C015864','OP/C015994','OP/C015995','OP/C016125','OP/C016126','OP/C016256','OP/C016257','OP/C016387','OP/C016388','OP/I050551','OP/C015866','OP/C015868','OP/C015997','OP/C015999','OP/C016128','OP/C016130','OP/C016259','OP/C016261','OP/C016390','OP/C016392','OP/C015867','OP/C015869','OP/C015998','OP/C016000','OP/C016129','OP/C016131','OP/C016260','OP/C016262','OP/C016391','OP/C016393','OP/C015870','OP/C016001','OP/C016132','OP/C016263','OP/C016394','OP/I050554','OP/C015871','OP/C016002','OP/C016133','OP/C016264','OP/C016395','OP/C016498','OP/I050556','OP/C015874','OP/C015875','OP/C015876','OP/C015877','OP/C015878','OP/C016005','OP/C016006','OP/C016007','OP/C016008','OP/C016009','OP/C016136','OP/C016137','OP/C016138','OP/C016139','OP/C016140','OP/C016267','OP/C016268','OP/C016269','OP/C016270','OP/C016271','OP/C016398','OP/C016399','OP/C016400','OP/C016401','OP/C016402','OP/C015873','OP/C016004','OP/C016135','OP/C016266','OP/C016397','OP/C015881','OP/C016012','OP/C016143','OP/C016274','OP/C016405','OP/C015879','OP/C015880','OP/C016010','OP/C016011','OP/C016141','OP/C016142','OP/C016272','OP/C016273','OP/C016403','OP/C016404','OP/C015882','OP/C016013','OP/C016144','OP/C016275','OP/C016406','OP/C015883','OP/C016014','OP/C016145','OP/C016276','OP/C016407','OP/C015884','OP/C015885','OP/C015886','OP/C016015','OP/C016016','OP/C016017','OP/C016146','OP/C016147','OP/C016148','OP/C016277','OP/C016278','OP/C016279','OP/C016408','OP/C016409','OP/C016410','OP/C015887','OP/C016018','OP/C016149','OP/C016280','OP/C016411','OP/C015888','OP/C016019','OP/C016150','OP/C016281','OP/C016412','OP/C015890','OP/C015891','OP/C016021','OP/C016022','OP/C016152','OP/C016153','OP/C016283','OP/C016284','OP/C016414','OP/C016415','OP/C015892','OP/C016023','OP/C016154','OP/C016285','OP/C016416','OP/C015893','OP/C016024','OP/C016155','OP/C016286','OP/C016417','OP/C015894','OP/C015895','OP/C016025','OP/C016026','OP/C016156','OP/C016157','OP/C016287','OP/C016288','OP/C016418','OP/C016419','OP/C015896','OP/C016027','OP/C016158','OP/C016289','OP/C016420','OP/C015897','OP/C015898','OP/C015899','OP/C015900','OP/C015901','OP/C015902','OP/C016028','OP/C016029','OP/C016030','OP/C016031','OP/C016032','OP/C016033','OP/C016159','OP/C016160','OP/C016161','OP/C016162','OP/C016163','OP/C016164','OP/C016290','OP/C016291','OP/C016292','OP/C016293','OP/C016294','OP/C016295','OP/C016421','OP/C016422','OP/C016423','OP/C016424','OP/C016425','OP/C016426','OP/I050566','OP/C015904','OP/C015905','OP/C015906','OP/C015907','OP/C016035','OP/C016036','OP/C016037','OP/C016038','OP/C016166','OP/C016167','OP/C016168','OP/C016169','OP/C016297','OP/C016298','OP/C016299','OP/C016300','OP/C016428','OP/C016429','OP/C016430','OP/C016431','OP/C016502','OP/C015908','OP/C015909','OP/C016039','OP/C016040','OP/C016170','OP/C016171','OP/C016301','OP/C016302','OP/C016432','OP/C016433','OP/I050529','OP/C015910','OP/C015912','OP/C015913','OP/C016041','OP/C016043','OP/C016044','OP/C016172','OP/C016174','OP/C016175','OP/C016303','OP/C016305','OP/C016306','OP/C016434','OP/C016436','OP/C016437','OP/C015911','OP/C016042','OP/C016173','OP/C016304','OP/C016435','OP/C015914','OP/C016045','OP/C016176','OP/C016307','OP/C016438','OP/C015915','OP/C015916','OP/C015917','OP/C015918','OP/C016046','OP/C016047','OP/C016048','OP/C016049','OP/C016177','OP/C016178','OP/C016179','OP/C016180','OP/C016308','OP/C016309','OP/C016310','OP/C016311','OP/C016439','OP/C016440','OP/C016441','OP/C016442','OP/C016510','OP/C015919','OP/C015921','OP/C015922','OP/C015923','OP/C016050','OP/C016052','OP/C016053','OP/C016054','OP/C016181','OP/C016183','OP/C016184','OP/C016185','OP/C016312','OP/C016314','OP/C016315','OP/C016316','OP/C016443','OP/C016445','OP/C016446','OP/C016447','OP/C016503','OP/C016511','OP/C016514','OP/C015920','OP/C016051','OP/C016182','OP/C016313','OP/C016444','OP/C015924','OP/C015925','OP/C016055','OP/C016056','OP/C016186','OP/C016187','OP/C016317','OP/C016318','OP/C016448','OP/C016449','OP/C016512','OP/C015926','OP/C016057','OP/C016188','OP/C016319','OP/C016450','OP/C015928','OP/C015929','OP/C015930','OP/C015932','OP/C016059','OP/C016060','OP/C016061','OP/C016063','OP/C016190','OP/C016191','OP/C016192','OP/C016194','OP/C016321','OP/C016322','OP/C016323','OP/C016325','OP/C016452','OP/C016453','OP/C016454','OP/C016456','OP/C016499','OP/C016515','OP/C015931','OP/C016062','OP/C016193','OP/C016324','OP/C016455','OP/C015933','OP/C015935','OP/C015936','OP/C016064','OP/C016066','OP/C016067','OP/C016195','OP/C016197','OP/C016198','OP/C016326','OP/C016328','OP/C016329','OP/C016457','OP/C016459','OP/C016460','OP/C015934','OP/C016065','OP/C016196','OP/C016327','OP/C016458','OP/C015937','OP/C015938','OP/C015939','OP/C015940','OP/C015941','OP/C015942','OP/C016068','OP/C016069','OP/C016070','OP/C016071','OP/C016072','OP/C016073','OP/C016199','OP/C016200','OP/C016201','OP/C016202','OP/C016203','OP/C016204','OP/C016330','OP/C016331','OP/C016332','OP/C016333','OP/C016334','OP/C016335','OP/C016461','OP/C016462','OP/C016463','OP/C016464','OP/C016465','OP/C016466','OP/C015943','OP/C016074','OP/C016205','OP/C016336','OP/C016467','OP/C015947','OP/C015948','OP/C015949','OP/C015950','OP/C016078','OP/C016079','OP/C016080','OP/C016081','OP/C016209','OP/C016210','OP/C016211','OP/C016212','OP/C016340','OP/C016341','OP/C016342','OP/C016343','OP/C016471','OP/C016472','OP/C016473','OP/C016474','OP/C015945','OP/C015946','OP/C016076','OP/C016077','OP/C016207','OP/C016208','OP/C016338','OP/C016339','OP/C016469','OP/C016470','OP/C015951','OP/C015952','OP/C016082','OP/C016083','OP/C016213','OP/C016214','OP/C016344','OP/C016345','OP/C016475','OP/C016476','OP/C015953','OP/C015955','OP/C015956','OP/C015957','OP/C015958','OP/C016084','OP/C016086','OP/C016087','OP/C016088','OP/C016089','OP/C016215','OP/C016217','OP/C016218','OP/C016219','OP/C016220','OP/C016346','OP/C016348','OP/C016349','OP/C016350','OP/C016351','OP/C016477','OP/C016479','OP/C016480','OP/C016481','OP/C016482','OP/C016504','OP/C016507','OP/C016516','OP/C016517','OP/C015954','OP/C015959','OP/C016085','OP/C016090','OP/C016216','OP/C016221','OP/C016347','OP/C016352','OP/C016478','OP/C016483','OP/C016508','OP/C015961','OP/C015962','OP/C016092','OP/C016093','OP/C016223','OP/C016224','OP/C016354','OP/C016355','OP/C016485','OP/C016486','OP/C015963','OP/C016094','OP/C016225','OP/C016356','OP/C016487','OP/C015964','OP/C015965','OP/C015966','OP/C015967','OP/C016095','OP/C016096','OP/C016097','OP/C016098','OP/C016226','OP/C016227','OP/C016228','OP/C016229','OP/C016357','OP/C016358','OP/C016359','OP/C016360','OP/C016488','OP/C016489','OP/C016490','OP/C016491','OP/C015969','OP/C015970','OP/C015971','OP/C015972','OP/C016100','OP/C016101','OP/C016102','OP/C016103','OP/C016231','OP/C016232','OP/C016233','OP/C016234','OP/C016362','OP/C016363','OP/C016364','OP/C016365','OP/C016493','OP/C016494','OP/C016495','OP/C016496','OP/C015973','OP/C016104','OP/C016235','OP/C016366','OP/C016497')

				AND			d1.order_no	LIKE '%CN%'
				AND			d1.line_type = 'S'
				GROUP BY	h1.customer)  t
			WHERE		t.customer = r.customer
		
		UPDATE 	@res SET customer = Right(customer, 2)
		--TRUNCATE TABLE VapeConnectTest.dbo.IMPDailySalesInformation

		INSERT INTO VapeConnectTest.dbo.IMPDailySalesInformation (BranchCode, TransactionDate, DailyDiscountValue, DailyCardValue, DailyCashValue, DailyPettyCashValue, ProductCode, Quantity, Value, LineDiscount, Processed)
		SELECT	*, 0
		FROM		@res
		ORDER BY	customer

		SELECT	*
		FROM		 VapeConnectTest.dbo.IMPDailySalesInformation
		WHERE		Processed =0
