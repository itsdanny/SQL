
DECLARE @res TABLE(customer VARCHAR(3), TransactionDate Date, DailyDiscountValue FLOAT, DailyCardValue FLOAT, DailyCashValue FLOAT, DailyPettyCashValue FLOAT, ProductCode VARCHAR(20), Qty INT, Value FLOAT, LineDisount FLOAT)

INSERT INTO  @res
SELECT	DISTINCT	LTRIM(RTRIM(h.customer)), 
				'2019-07-31' AS TransactionDate,
				0 AS DailyDiscountValue,
				0 AS DailyCardValue,
				0 AS DailyCashValue,
				0 AS DailyPettyCashValue,
				LTRIM(RTRIM(d.product)) AS ProductCode,  
				CASE d.line_type WHEN 'S' THEN '1' ELSE SUM(d.despatched_qty) END AS Qty, /* SERVICE CODES HAVE 0 PRICE SO USE net_price instea */
				SUM(d.list_price) AS Value,
				0 AS LineDisount

	FROM		demo.scheme.opheadm h
	INNER JOIN 	demo.scheme.opdetm d
	ON			h.order_no = d.order_no
	WHERE		h.invoice_no IN ('OP/C015715','OP/C015716','OP/C015717','OP/C015718','OP/C015719','OP/C015720','OP/C015722','OP/C015723','OP/C015724','OP/C015725','OP/C015726','OP/C015727','OP/C015728','OP/C015729','OP/C015732','OP/C015733','OP/C015730','OP/C015731','OP/C015737','OP/C015735','OP/C015736','OP/C015738','OP/C015742','OP/C015743','OP/C015745','OP/C015746','OP/C015747','OP/C015748','OP/C015749','OP/C015744','OP/C015752','OP/C015750','OP/C015751','OP/C015753','OP/C015754','OP/C015755','OP/C015756','OP/C015758','OP/C015759','OP/C015764','OP/C015765','OP/C015767','OP/C015768','OP/C015769','OP/C015770','OP/C015771','OP/C015772','OP/I050238','OP/C015773','OP/C015774','OP/C015775','OP/C015776','OP/C015777','OP/C015778','OP/C015779','OP/C015781','OP/C015780','OP/C015783','OP/C015784','OP/C015785','OP/C015786','OP/C015787','OP/C015788','OP/C015790','OP/C015791','OP/C015792','OP/I050502','OP/I050503','OP/C015789','OP/C015793','OP/C015794','OP/C015795','OP/C015796','OP/C015797','OP/C015798','OP/I050506','OP/C015799','OP/C015801','OP/C015803','OP/C015802','OP/C015805','OP/C015806','OP/C015807','OP/C015808','OP/C015809','OP/C015810','OP/C015814','OP/C015815','OP/C015816','OP/C015812','OP/C015813','OP/C015818','OP/C015819','OP/C015820','OP/C015822','OP/C015823','OP/C015824','OP/C015825','OP/I050512','OP/I050513','OP/C015821','OP/C015827','OP/C015828','OP/C015830','OP/C015831','OP/C015832','OP/C015834','OP/C015835','OP/C015836','OP/C015838','OP/C015605','OP/C015606','OP/I050427','OP/C015608','OP/C015609','OP/I050429','OP/C015611','OP/C015612','OP/C015613','OP/C015614','OP/C015615','OP/I050431','OP/C015617','OP/C015618','OP/C015621','OP/C015622','OP/C015619','OP/C015620','OP/C015625','OP/C015623','OP/C015624','OP/C015626','OP/C015629','OP/C015630','OP/C015632','OP/C015633','OP/C015634','OP/C015635','OP/C015631','OP/C015639','OP/C015637','OP/C015638','OP/C015640','OP/C015641','OP/C015642','OP/C015644','OP/C015645','OP/C015649','OP/C015650','OP/C015651','OP/C015652','OP/C015653','OP/C015654','OP/C015655','OP/C015657','OP/C015658','OP/C015659','OP/C015660','OP/C015661','OP/C015662','OP/C015663','OP/C015664','OP/C015666','OP/C015667','OP/C015668','OP/C015669','OP/C015671','OP/C015673','OP/C015674','OP/C015672','OP/C015676','OP/C015677','OP/C015678','OP/C015679','OP/C015680','OP/C015681','OP/C015683','OP/C015685','OP/C015684','OP/C015686','OP/C015687','OP/C015688','OP/C015689','OP/C015690','OP/C015691','OP/C015694','OP/C015695','OP/C015692','OP/C015693','OP/C015697','OP/C015698','OP/C015699','OP/C015701','OP/C015702','OP/C015703','OP/C015700','OP/C015705','OP/C015706','OP/C015708','OP/C015709','OP/C015710','OP/C015711','OP/C015712','OP/C015713','OP/C015714','OP/C015507','OP/C015508','OP/C015509','OP/I050384','OP/C015511','OP/C015512','OP/C015513','OP/C015514','OP/C015515','OP/I050386','OP/C015516','OP/C015517','OP/C015520','OP/C015518','OP/C015519','OP/C015522','OP/C015523','OP/C015525','OP/C015528','OP/C015529','OP/C015531','OP/C015532','OP/C015533','OP/C015534','OP/C015530','OP/C015537','OP/C015535','OP/C015536','OP/C015538','OP/I050398','OP/C015540','OP/C015541','OP/C015542','OP/C015546','OP/C015548','OP/C015549','OP/C015550','OP/C015551','OP/C015553','OP/C015554','OP/C015555','OP/C015556','OP/C015557','OP/C015558','OP/C015559','OP/C015560','OP/C015561','OP/C015562','OP/C015563','OP/C015564','OP/I050410','OP/C015565','OP/C015567','OP/C015566','OP/C015569','OP/C015570','OP/I050413','OP/C015571','OP/C015572','OP/C015573','OP/C015574','OP/C015575','OP/C015576','OP/C015578','OP/C015579','OP/C015580','OP/C015581','OP/C015582','OP/C015586','OP/C015584','OP/C015585','OP/C015588','OP/C015589','OP/C015590','OP/C015592','OP/C015593','OP/C015594','OP/C015591','OP/C015595','OP/C015596','OP/C015598','OP/C015599','OP/C015600','OP/C015601','OP/C015602','OP/C015603','OP/C015604','OP/C015473','OP/I050309','OP/C015474','OP/C015475','OP/C015476','OP/C015477','OP/C015478','OP/C015479','OP/C015480','OP/C015481','OP/C015482','OP/I050350','OP/C015483','OP/C015484','OP/C015281','OP/C015345','OP/I050305','OP/C015268','OP/C015269','OP/C015270','OP/C015271','OP/C015282','OP/C015283','OP/C015284','OP/C015285','OP/C015346','OP/C015347','OP/C015348','OP/C015349','OP/C015410','OP/C015411','OP/C015412','OP/C015272','OP/C015286','OP/C015350','OP/C015273','OP/C015276','OP/C015287','OP/C015290','OP/C015351','OP/C015354','OP/C015415','OP/C015274','OP/C015275','OP/C015288','OP/C015289','OP/C015352','OP/C015353','OP/C015416','OP/C015417','OP/C015291','OP/C015355','OP/C015419','OP/C015277','OP/C015292','OP/C015356','OP/I050269','OP/C015279','OP/C015280','OP/C015294','OP/C015295','OP/C015358','OP/C015359','OP/C015422','OP/C015278','OP/C015293','OP/C015357','OP/C015421','OP/C015296','OP/C015297','OP/C015360','OP/C015361','OP/C015424','OP/C015425','OP/C015298','OP/C015362','OP/C015426','OP/C015299','OP/C015363','OP/C015300','OP/C015364','OP/C015428','OP/C015303','OP/C015367','OP/C015431','OP/C015304','OP/C015305','OP/C015306','OP/C015307','OP/C015368','OP/C015369','OP/C015370','OP/C015371','OP/C015432','OP/C015433','OP/C015434','OP/C015435','OP/C015308','OP/C015309','OP/C015310','OP/C015311','OP/C015372','OP/C015373','OP/C015374','OP/C015375','OP/C015436','OP/C015437','OP/C015438','OP/I050306','OP/C015312','OP/C015313','OP/C015376','OP/C015377','OP/C015440','OP/C015441','OP/I050284','OP/C015314','OP/C015378','OP/C015442','OP/C015315','OP/C015379','OP/C015443','OP/C015316','OP/C015380','OP/C015317','OP/C015381','OP/C015445','OP/C015318','OP/C015382','OP/C015446','OP/I050288','OP/C015319','OP/C015383','OP/C015447','OP/C015320','OP/C015321','OP/C015384','OP/C015385','OP/C015448','OP/C015449','OP/C015322','OP/C015386','OP/C015450','OP/C015323','OP/C015324','OP/C015387','OP/C015388','OP/C015451','OP/C015452','OP/I050291','OP/C015325','OP/C015389','OP/C015453','OP/C015326','OP/C015327','OP/C015328','OP/C015390','OP/C015391','OP/C015392','OP/C015454','OP/C015455','OP/C015329','OP/C015330','OP/C015393','OP/C015394','OP/C015457','OP/C015458','OP/C015331','OP/C015332','OP/C015395','OP/C015396','OP/C015459','OP/C015460','OP/C015333','OP/C015335','OP/C015336','OP/C015397','OP/C015399','OP/C015400','OP/C015461','OP/C015463','OP/I050297','OP/I050298','OP/C015334','OP/C015398','OP/C015462','OP/I050299','OP/C015337','OP/C015338','OP/C015401','OP/C015402','OP/C015465','OP/C015466','OP/C015340','OP/C015341','OP/C015342','OP/C015404','OP/C015405','OP/C015406','OP/C015468','OP/C015469','OP/C015470','OP/C015343','OP/C015344','OP/C015407','OP/C015408','OP/C015471','OP/C015216','OP/C015217','OP/C015218','OP/C015219','OP/C015220','OP/C015222','OP/C015224','OP/C015223','OP/C015225','OP/C015226','OP/C015227','OP/C015230','OP/C015231','OP/C015232','OP/C015233','OP/C015235','OP/C015236','OP/C015238','OP/C015239','OP/C015240','OP/C015241','OP/C015242','OP/C015243','OP/C015245','OP/C015246','OP/C015248','OP/C015250','OP/C015251','OP/C015253','OP/C015254','OP/C015255','OP/C015257','OP/C015260','OP/C015263','OP/C015264','OP/C015265','OP/C015153','OP/C015154','OP/C015180','OP/C015155','OP/C015156','OP/C015158','OP/C015157','OP/C015184','OP/C015159','OP/C015160','OP/C015187','OP/I050149','OP/C015162','OP/C015163','OP/C015164','OP/C015190','OP/C015191','OP/I050175','OP/C015165','OP/C015166','OP/C015167','OP/C015193','OP/C015168','OP/C015195','OP/C015169','OP/C015196','OP/C015170','OP/I050160','OP/I050176','OP/C015171','OP/C015172','OP/C015198','OP/C015173','OP/C015174','OP/C015201','OP/C015175','OP/C015176','OP/I050168','OP/C015177','OP/C015178','OP/C015179','OP/C015205')
	AND			d.despatched_qty > 0
	AND			h.order_no	LIKE '%CN%'
	AND			d.line_type <> 'S'
	GROUP BY 	LTRIM(RTRIM(h.customer)), LTRIM(RTRIM(d.product)),d.line_type
	ORDER BY	1, 2


	UPDATE 	r
	SET		r.DailyDiscountValue = t.discount
	FROM	@res r, 
	(SELECT		SUM(d1.val) AS discount, h1.customer
				 FROM			demo.scheme.opheadm h1
			INNER JOIN 	demo.scheme.opdetm d1
			ON			h1.order_no = d1.order_no
			WHERE		h1.invoice_no IN ('OP/C015715','OP/C015716','OP/C015717','OP/C015718','OP/C015719','OP/C015720','OP/C015722','OP/C015723','OP/C015724','OP/C015725','OP/C015726','OP/C015727','OP/C015728','OP/C015729','OP/C015732','OP/C015733','OP/C015730','OP/C015731','OP/C015737','OP/C015735','OP/C015736','OP/C015738','OP/C015742','OP/C015743','OP/C015745','OP/C015746','OP/C015747','OP/C015748','OP/C015749','OP/C015744','OP/C015752','OP/C015750','OP/C015751','OP/C015753','OP/C015754','OP/C015755','OP/C015756','OP/C015758','OP/C015759','OP/C015764','OP/C015765','OP/C015767','OP/C015768','OP/C015769','OP/C015770','OP/C015771','OP/C015772','OP/I050238','OP/C015773','OP/C015774','OP/C015775','OP/C015776','OP/C015777','OP/C015778','OP/C015779','OP/C015781','OP/C015780','OP/C015783','OP/C015784','OP/C015785','OP/C015786','OP/C015787','OP/C015788','OP/C015790','OP/C015791','OP/C015792','OP/I050502','OP/I050503','OP/C015789','OP/C015793','OP/C015794','OP/C015795','OP/C015796','OP/C015797','OP/C015798','OP/I050506','OP/C015799','OP/C015801','OP/C015803','OP/C015802','OP/C015805','OP/C015806','OP/C015807','OP/C015808','OP/C015809','OP/C015810','OP/C015814','OP/C015815','OP/C015816','OP/C015812','OP/C015813','OP/C015818','OP/C015819','OP/C015820','OP/C015822','OP/C015823','OP/C015824','OP/C015825','OP/I050512','OP/I050513','OP/C015821','OP/C015827','OP/C015828','OP/C015830','OP/C015831','OP/C015832','OP/C015834','OP/C015835','OP/C015836','OP/C015838','OP/C015605','OP/C015606','OP/I050427','OP/C015608','OP/C015609','OP/I050429','OP/C015611','OP/C015612','OP/C015613','OP/C015614','OP/C015615','OP/I050431','OP/C015617','OP/C015618','OP/C015621','OP/C015622','OP/C015619','OP/C015620','OP/C015625','OP/C015623','OP/C015624','OP/C015626','OP/C015629','OP/C015630','OP/C015632','OP/C015633','OP/C015634','OP/C015635','OP/C015631','OP/C015639','OP/C015637','OP/C015638','OP/C015640','OP/C015641','OP/C015642','OP/C015644','OP/C015645','OP/C015649','OP/C015650','OP/C015651','OP/C015652','OP/C015653','OP/C015654','OP/C015655','OP/C015657','OP/C015658','OP/C015659','OP/C015660','OP/C015661','OP/C015662','OP/C015663','OP/C015664','OP/C015666','OP/C015667','OP/C015668','OP/C015669','OP/C015671','OP/C015673','OP/C015674','OP/C015672','OP/C015676','OP/C015677','OP/C015678','OP/C015679','OP/C015680','OP/C015681','OP/C015683','OP/C015685','OP/C015684','OP/C015686','OP/C015687','OP/C015688','OP/C015689','OP/C015690','OP/C015691','OP/C015694','OP/C015695','OP/C015692','OP/C015693','OP/C015697','OP/C015698','OP/C015699','OP/C015701','OP/C015702','OP/C015703','OP/C015700','OP/C015705','OP/C015706','OP/C015708','OP/C015709','OP/C015710','OP/C015711','OP/C015712','OP/C015713','OP/C015714','OP/C015507','OP/C015508','OP/C015509','OP/I050384','OP/C015511','OP/C015512','OP/C015513','OP/C015514','OP/C015515','OP/I050386','OP/C015516','OP/C015517','OP/C015520','OP/C015518','OP/C015519','OP/C015522','OP/C015523','OP/C015525','OP/C015528','OP/C015529','OP/C015531','OP/C015532','OP/C015533','OP/C015534','OP/C015530','OP/C015537','OP/C015535','OP/C015536','OP/C015538','OP/I050398','OP/C015540','OP/C015541','OP/C015542','OP/C015546','OP/C015548','OP/C015549','OP/C015550','OP/C015551','OP/C015553','OP/C015554','OP/C015555','OP/C015556','OP/C015557','OP/C015558','OP/C015559','OP/C015560','OP/C015561','OP/C015562','OP/C015563','OP/C015564','OP/I050410','OP/C015565','OP/C015567','OP/C015566','OP/C015569','OP/C015570','OP/I050413','OP/C015571','OP/C015572','OP/C015573','OP/C015574','OP/C015575','OP/C015576','OP/C015578','OP/C015579','OP/C015580','OP/C015581','OP/C015582','OP/C015586','OP/C015584','OP/C015585','OP/C015588','OP/C015589','OP/C015590','OP/C015592','OP/C015593','OP/C015594','OP/C015591','OP/C015595','OP/C015596','OP/C015598','OP/C015599','OP/C015600','OP/C015601','OP/C015602','OP/C015603','OP/C015604','OP/C015473','OP/I050309','OP/C015474','OP/C015475','OP/C015476','OP/C015477','OP/C015478','OP/C015479','OP/C015480','OP/C015481','OP/C015482','OP/I050350','OP/C015483','OP/C015484','OP/C015281','OP/C015345','OP/I050305','OP/C015268','OP/C015269','OP/C015270','OP/C015271','OP/C015282','OP/C015283','OP/C015284','OP/C015285','OP/C015346','OP/C015347','OP/C015348','OP/C015349','OP/C015410','OP/C015411','OP/C015412','OP/C015272','OP/C015286','OP/C015350','OP/C015273','OP/C015276','OP/C015287','OP/C015290','OP/C015351','OP/C015354','OP/C015415','OP/C015274','OP/C015275','OP/C015288','OP/C015289','OP/C015352','OP/C015353','OP/C015416','OP/C015417','OP/C015291','OP/C015355','OP/C015419','OP/C015277','OP/C015292','OP/C015356','OP/I050269','OP/C015279','OP/C015280','OP/C015294','OP/C015295','OP/C015358','OP/C015359','OP/C015422','OP/C015278','OP/C015293','OP/C015357','OP/C015421','OP/C015296','OP/C015297','OP/C015360','OP/C015361','OP/C015424','OP/C015425','OP/C015298','OP/C015362','OP/C015426','OP/C015299','OP/C015363','OP/C015300','OP/C015364','OP/C015428','OP/C015303','OP/C015367','OP/C015431','OP/C015304','OP/C015305','OP/C015306','OP/C015307','OP/C015368','OP/C015369','OP/C015370','OP/C015371','OP/C015432','OP/C015433','OP/C015434','OP/C015435','OP/C015308','OP/C015309','OP/C015310','OP/C015311','OP/C015372','OP/C015373','OP/C015374','OP/C015375','OP/C015436','OP/C015437','OP/C015438','OP/I050306','OP/C015312','OP/C015313','OP/C015376','OP/C015377','OP/C015440','OP/C015441','OP/I050284','OP/C015314','OP/C015378','OP/C015442','OP/C015315','OP/C015379','OP/C015443','OP/C015316','OP/C015380','OP/C015317','OP/C015381','OP/C015445','OP/C015318','OP/C015382','OP/C015446','OP/I050288','OP/C015319','OP/C015383','OP/C015447','OP/C015320','OP/C015321','OP/C015384','OP/C015385','OP/C015448','OP/C015449','OP/C015322','OP/C015386','OP/C015450','OP/C015323','OP/C015324','OP/C015387','OP/C015388','OP/C015451','OP/C015452','OP/I050291','OP/C015325','OP/C015389','OP/C015453','OP/C015326','OP/C015327','OP/C015328','OP/C015390','OP/C015391','OP/C015392','OP/C015454','OP/C015455','OP/C015329','OP/C015330','OP/C015393','OP/C015394','OP/C015457','OP/C015458','OP/C015331','OP/C015332','OP/C015395','OP/C015396','OP/C015459','OP/C015460','OP/C015333','OP/C015335','OP/C015336','OP/C015397','OP/C015399','OP/C015400','OP/C015461','OP/C015463','OP/I050297','OP/I050298','OP/C015334','OP/C015398','OP/C015462','OP/I050299','OP/C015337','OP/C015338','OP/C015401','OP/C015402','OP/C015465','OP/C015466','OP/C015340','OP/C015341','OP/C015342','OP/C015404','OP/C015405','OP/C015406','OP/C015468','OP/C015469','OP/C015470','OP/C015343','OP/C015344','OP/C015407','OP/C015408','OP/C015471','OP/C015216','OP/C015217','OP/C015218','OP/C015219','OP/C015220','OP/C015222','OP/C015224','OP/C015223','OP/C015225','OP/C015226','OP/C015227','OP/C015230','OP/C015231','OP/C015232','OP/C015233','OP/C015235','OP/C015236','OP/C015238','OP/C015239','OP/C015240','OP/C015241','OP/C015242','OP/C015243','OP/C015245','OP/C015246','OP/C015248','OP/C015250','OP/C015251','OP/C015253','OP/C015254','OP/C015255','OP/C015257','OP/C015260','OP/C015263','OP/C015264','OP/C015265','OP/C015153','OP/C015154','OP/C015180','OP/C015155','OP/C015156','OP/C015158','OP/C015157','OP/C015184','OP/C015159','OP/C015160','OP/C015187','OP/I050149','OP/C015162','OP/C015163','OP/C015164','OP/C015190','OP/C015191','OP/I050175','OP/C015165','OP/C015166','OP/C015167','OP/C015193','OP/C015168','OP/C015195','OP/C015169','OP/C015196','OP/C015170','OP/I050160','OP/I050176','OP/C015171','OP/C015172','OP/C015198','OP/C015173','OP/C015174','OP/C015201','OP/C015175','OP/C015176','OP/I050168','OP/C015177','OP/C015178','OP/C015179','OP/C015205')
				AND			d1.order_no	LIKE '%CN%'
				AND			d1.line_type = 'S'
				GROUP BY	h1.customer)  t
			WHERE		t.customer = r.customer
		
		TRUNCATE TABLE VapeConnectTest.dbo.IMPDailySalesInformation

		INSERT INTO VapeConnectTest.dbo.IMPDailySalesInformation (BranchCode, TransactionDate, DailyDiscountValue, DailyCardValue, DailyCashValue, DailyPettyCashValue, ProductCode, Quantity, Value, LineDiscount)
		SELECT	*
		FROM		@res
		ORDER BY	customer